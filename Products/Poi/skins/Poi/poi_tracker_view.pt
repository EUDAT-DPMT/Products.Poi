<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US"
      lang="en-US"
      metal:use-macro="here/main_template/macros/master"
      i18n:domain="Poi">

  <head>
    <metal:css fill-slot="css_slot">
      <style type="text/css" media="all"
        tal:content="string: @import url($portal_url/poi.css);"></style>
    </metal:css>
  </head>

<body>
  <div metal:fill-slot="main">
    <div metal:define-macro="body" 
      tal:define="openStates python:['open', 'in-progress'];
                  pendingStates python:openStates + ['unconfirmed', 'resolved'];
                  issueQueryString python:'%s/poi_issue_search?state=%s' % (here.absolute_url(), '&state='.join(openStates),);
                  isManager python:member.getId() in here.getManagers()">

      <div metal:use-macro="here/document_actions/macros/document_actions">
        Document actions (print, sendto etc)
      </div>

      <h1 tal:content="here/Title" class="documentFirstHeading">
        Tracker Title
      </h1>
      
      <div class="documentDescription" tal:content="here/Description">
        Description.
      </div>

      <div class="formControls">
          <form action="createObject"
                 tal:condition="python: user.has_permission('Poi: Add Issue', here)">
            <input name="type_name"
                   type="hidden"
                   value="PoiIssue"
                   />
            <input class="standalone"
                   type="submit"
                   i18n:attributes="value"
                   value="Submit new issue"
                   />
          </form>
      </div>
      
      <h2 i18n:translate="poi_heading_open_issues">Open issues</h2>
      
      <a id="issue-search-link" 
         tal:attributes="href string:${here/absolute_url}/poi_issue_search_form" 
         i18n:translate="poi_issue_search">Search for issues</a>
      
      <p i18n:translate="poi_help_open_issues">
          Click an area, release or issue state to see all open issues in that
          category. For more advanced search options, click "search for issues".
      </p>


      <div id="open-issues-by-area" class="issue-quick-search-box">
          <h3 i18n:translate="poi_heading_by_area">By area</h3>
          <ul>
              <tal:areas repeat="area python:here.getWrappedField('availableAreas').getAsGrid(here)">
                <li tal:define="areaId          python:area[0];
                                areaTitle       python:area[1];
                                areaDescription python:area[2];
                                issues          python:here.getFilteredIssues(area=areaId, state=openStates)">
                <a tal:attributes="href string:${issueQueryString}&area=${areaId};
                                   title areaDescription" 
                   tal:content="areaTitle" /> (<span tal:replace="python:len(issues)" />)
                </li>
              </tal:areas>
          </ul>
      </div>
      
      <div id="open-issues-by-release" class="issue-quick-search-box"
           tal:condition="here/isUsingReleases">
          <h3 i18n:translate="poi_heading_by_release">By release</h3>
          <ul tal:define="releases here/getReleasesVocab">
              <tal:releases repeat="release releases">
                  <li tal:define="issues python:here.getFilteredIssues(release=release, state=openStates)">
                    <a tal:attributes="href string:${issueQueryString}&release=${release}"
                       tal:content="python:releases.getValue(release)" /> (<span tal:replace="python:len(issues)" />)
                  </li>
              </tal:releases>
          </ul>
      </div>
      
      <div id="open-issues-by-state" class="issue-quick-search-box"
           tal:define="issueStates here/getIssueWorkflowStates">
          <h3 i18n:translate="poi_heading_by_release">By state</h3>
          <ul>
              <tal:releases repeat="state issueStates">
                  <li tal:define="issues python:here.getFilteredIssues(state=state)">
                    <a tal:attributes="href string:${here/absolute_url}/poi_issue_search?state=${state}"
                       tal:content="python:issueStates.getValue(state)" /> (<span tal:replace="python:len(issues)" />)
                  </li>
              </tal:releases>
          </ul>
      </div>
      
      <div class="visualClear"><!----></div>
      
      <div id="open-issues-by-tag" class="issue-quick-search-box"
          tal:define="tags here/getTagsInUse"
          tal:condition="python:isManager and len(tags) > 0">
          <h3>By tag</h3>
          <div>
            <span tal:repeat="tag tags">
                <a tal:attributes="href string:${issueQueryString}&tags=${tag}"
                   tal:content="tag" /> 
                <span tal:condition="not:repeat/tag/end"> ~ </span>
            </span>
          </div>
      </div>
      
      <div class="visualClear"><!----></div>
      
      <tal:manager condition="isManager">
          <div id="unassigned-issues"
               tal:define="issues python:here.getFilteredIssues(state='unconfirmed')"
               tal:condition="nocall:issues">
               
               <h2 i18n:translate="poi_heading_unconfirmed_issues">Unconfirmed issues</h2>
               <p i18n:translate="poi_help_unconfirmed_issues">
                   The following issues have not yet been confirmed or assigned. Please
                   review them and take the appropriate action.
               </p>
               
               <metal:table use-macro="here/poi_issue_search/macros/issue_search_results" />
               
          </div>
          
      </tal:manager>
      <tal:loggedIn condition="not:isAnon">
          <div id="my-issues"
               tal:define="issues python:here.getFilteredIssues(state=openStates, responsible=member.getId()) + here.getFilteredIssues(state=pendingStates, creator=member.getId())"
               tal:condition="nocall:issues">
           
               <h2 i18n:translate="poi_heading_my_issues">My issues</h2>
               <p tal:condition="isManager" i18n:translate="poi_help_my_issues_manager">
                   The following open issues were either submitted by you, or have been assigned to you.
               </p>
           
               <p tal:condition="not:isManager" i18n:translate="poi_help_my_issues_not_manager">
                   The following open issues were either submitted by you.
               </p>

               <metal:table use-macro="here/poi_issue_search/macros/issue_search_results" />
           
          </div>
      </tal:loggedIn>
  
    </div>

  </div>
</body>

</html>

