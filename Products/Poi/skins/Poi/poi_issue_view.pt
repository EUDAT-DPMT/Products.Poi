<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US"
      lang="en-US"
      metal:use-macro="here/main_template/macros/master"
      i18n:domain="Poi">

  <head>
    <metal:css fill-slot="css_slot">
      <style type="text/css" media="all"
        tal:content="string: @import url($portal_url/poi.css);"></style>
    </metal:css>
  </head>

<body>
<div metal:fill-slot="main"
        tal:define="wftool here/portal_workflow;
                    isManager python:member.getId() in here.getManagers();
                    isSubmitter python:member.getId() == here.Creator()">
    
    <div metal:define-macro="body">

      <div metal:use-macro="here/document_actions/macros/document_actions">
        Document actions (print, sendto etc)
      </div>
      
      <h1 tal:content="here/Title" class="documentFirstHeading">
        Issue Title
      </h1>      
            
      <table class="vertical listing issue-info-box">
          <tr tal:condition="here/isUsingReleases">
              <th i18n:translate="poi_label_release">Release:</th>
              <td tal:condition="here/isUsingReleases">
                  <span tal:define="releases here/getReleasesVocab"
                          tal:condition="python:here.getRelease() != '(UNASSIGNED)'"
                          tal:replace="python:releases.getValue(here.getRelease())" />
                  <div tal:condition="python:here.getRelease() == '(UNASSIGNED)'" class="unassigned-field">
                      &mdash;
                  </div>
              </td>
          </tr>
          <tr>
              <th i18n:translate="poi_label_area">Area</th>
              <td tal:content="python:here.aq_parent.getDataGridRow('availableAreas', here.getArea())['title']" />
          </tr>
          <tr>
              <th i18n:translate="poi_label_type">Issue type</th>
              <td tal:content="python:here.aq_parent.getDataGridRow('availableIssueTypes', here.getIssueType())['title']" />
          </tr>
          <tr>
              <th i18n:translate="poi_label_severity">Severity</th>
              <td tal:content="here/getSeverity" />
          </tr>
          <tr>
              <th i18n:translate="poi_label_submitted_by">Submitted by</th>
              <td tal:content="here/Creator" />
          </tr>
          <tr>
              <th i18n:translate="poi_label_submitted_on">Submitted on</th>
              <td tal:content="python:here.toLocalizedTime(here.created())" />
          </tr>
          <tr>
              <th i18n:translate="poi_label_responsible">Responsible</th>
              <td>
                  <span tal:condition="python:here.getResponsibleManager() != '(UNASSIGNED)'" 
                         tal:replace="here/getResponsibleManager" />
                  <div tal:condition="python:here.getResponsibleManager() == '(UNASSIGNED)'" class="unassigned-field">
                      &mdash;
                  </div>
              </td>
          </tr>
          <tr tal:define="state python:wftool.getInfoFor(here, 'review_state')">
              <th i18n:translate="poi_label_state">State</th>
              <td tal:content="state" tal:attributes="class string:issue-${state}"/>
          </tr>
      </table>
      
      <div class="issue-tags" tal:condition="here/Subject">
          <span class="issue-tags-label" i18n:translate="poi_label_tags">Tags:</span> 
          <span class="issue-tags-tags" tal:content="python:', '.join(here.Subject())" />
      </div>
      
      <div class="documentDescription" tal:content="here/Description" />
          
      <div tal:content="structure here/getDetails" />
  
      <div class="steps-to-reproduce" tal:condition="here/getSteps">
          <span i18n:translate="poi_label_steps">Steps to reproduce:</span>
            <ol>
                <li tal:repeat="step here/getSteps" tal:content="step" />
            </ol>
      </div>
      
      <div class="issue-attachment" tal:condition="python:here.getAttachment().get_size() &gt; 0">
          <div class="issue-attachment-label" i18n:translate="poi_label_attachment">Attached:</div>
          <metal:attachment use-macro="python:here.widget('attachment')"/>
      </div>
      
      <div class="formControls">
          <form style="display: inline" action="createObject"
              tal:condition="python: user.has_permission('Poi: Add Response', here)">
            <input name="type_name"
                   type="hidden"
                   value="PoiResponse"
                   />
            <input class="standalone"
                   type="submit"
                   i18n:attributes="value"
                   value="Add response"
                   />
          </form>
          <form style="display: inline" action="toggleWatchingIssue"
              tal:condition="python: not isAnon and not isManager and not isSubmitter">
              <input tal:condition="here/isWatching"
                     class="standalone"
                     type="submit"
                     i18n:attributes="value"
                     value="Stop watching this issue"
                   />
            <input tal:condition="not:here/isWatching"
                   class="standalone"
                   type="submit"
                   i18n:attributes="value"
                   value="Watch this issue"
                   />
          </form>
      </div>
      
      <div class="visualClear"><!----></div>

      <tal:responses repeat="response python:here.getFolderContents(contentFilter = {'sort_on' : 'getId'}, full_objects = True)">
      
        <div class="response-details" metal:define-macro="response_view"
                tal:attributes="class string:response-${response/determineResponseType}">
                  
          
            <div class="response-actions"
                  tal:define="canEdit   python:user.has_permission('Modify portal content', response);
                              canDelete python:user.has_permission('Delete objects', response)"
                  tal:condition="python:canEdit or canDelete">
              <form tal:attributes="action string:${response/absolute_url}/base_edit">
                <input class="standalone"
                       type="submit"
                       i18n:attributes="value"
                       value="Edit"
                       />
              </form>
              <form tal:attributes="action string:${response/absolute_url}/poi_response_delete_confirm">
                <input class="destructive"
                       type="submit"
                       i18n:attributes="value"
                       value="Delete"
                       />
              </form>
            </div>
          
            <div class="response-info"
                 tal:define="stateBefore response/getIssueStateBefore;
                             stateAfter  response/getIssueStateAfter;">
              <span i18n:translate="poi_added_by">Added by</span>
              <span class="contact-user" tal:content="response/Creator" />
              <span i18n:translate="poi_added_on">on</span>
              <span class="contact-user" 
                    tal:content="python:here.toLocalizedTime(response.Date(), long_format=True)" />
              <div tal:condition="python:stateBefore and stateAfter and stateBefore != stateAfter">
                  <span i18n:translate="poi_response_state_change">Changed issue state:</span>
                  <span tal:replace="stateBefore" /> &rarr; <span tal:replace="stateAfter" />
              </div>
            </div>
      
            <div tal:content="structure response/getResponse" />
            
            <div class="issue-attachment" tal:condition="python:response.getAttachment().get_size() &gt; 0">
              <div class="issue-attachment-label" i18n:translate="poi_label_attachment">Attached:</div>
              <metal:attachment use-macro="python:response.widget('attachment')"/>
            </div>
      
        </div>
      
      </tal:responses>
      <div class="visualClear"><!----></div>
  </div>
</div>

</body>
</html>
